/**
* 预览页面解密工具 - 压缩版
* 用于解密从CodeSandbox组件传递的加密内容
*/
const decryptContent=(encryptedData,key='CodeSandbox2025')=>{try{let processedData=encryptedData;/%[0-9A-Fa-f]{2}/.test(encryptedData)&&(processedData=decodeURIComponent(encryptedData));const base64String=processedData.replace(/-/g,'+').replace(/_/g,'/');let paddedBase64=base64String;while(paddedBase64.length%4)paddedBase64+='=';const base64Decoded=atob(paddedBase64);const utf8Bytes=new Uint8Array(base64Decoded.split('').map(char=>char.charCodeAt(0)));const decoded=new TextDecoder().decode(utf8Bytes);const xorDecoded=decoded.split('').map((char,index)=>{const keyChar=key[index%key.length];if(!keyChar)throw new Error('解密密钥不能为空');return String.fromCharCode(char.charCodeAt(0)^keyChar.charCodeAt(0))}).join('');return xorDecoded}catch(error){console.error('内容解密失败:',error);console.error('错误详情:',{encryptedData,dataType:typeof encryptedData,dataLength:encryptedData?.length});try{const base64Decoded=atob(processedData);return base64Decoded.split('').map((char,index)=>{const keyChar=key[index%key.length];if(!keyChar)throw new Error('解密密钥不能为空');return String.fromCharCode(char.charCodeAt(0)^keyChar.charCodeAt(0))}).join('')}catch(fallbackError){console.error('回退解密也失败:',fallbackError);return decodeURIComponent(encryptedData)}}};
const getDataFromIndexedDB=async token=>{try{if(!window.indexedDB){console.warn('浏览器不支持 IndexedDB');return null}const db=await openIndexedDB();const transaction=db.transaction(['previews'],'readwrite');const store=transaction.objectStore('previews');const request=store.get(token);return new Promise((resolve,reject)=>{request.onsuccess=()=>{const data=request.result;if(!data){console.warn('未找到token对应的数据');resolve(null);return}if(data.used){console.warn('数据已被使用，可能重复访问');resolve(null);return}const deleteRequest=store.delete(token);deleteRequest.onsuccess=()=>{console.log('数据已清理，token:',token)};deleteRequest.onerror=()=>{console.warn('数据清理失败:',deleteRequest.error)};resolve(data.content)};request.onerror=()=>{console.error('获取数据失败:',request.error);reject(request.error)}})}catch(error){console.error('IndexedDB操作失败:',error);return null}};
const openIndexedDB=()=>new Promise((resolve,reject)=>{const request=indexedDB.open('CodeSandboxDB',1);request.onerror=()=>reject(request.error);request.onsuccess=()=>resolve(request.result);request.onupgradeneeded=event=>{const db=event.target.result;if(!db.objectStoreNames.contains('previews'))db.createObjectStore('previews')}});
const getDecryptedContent=async()=>{try{const urlParams=new URLSearchParams(window.location.search);const token=urlParams.get('token');const encryptedContent=urlParams.get('content');if(token){console.log('使用token方式获取数据');const jsonData=await getDataFromIndexedDB(token);if(!jsonData){console.error('未找到有效的token数据');return null}try{const data=JSON.parse(jsonData);console.log('token方式成功解析数据');return data}catch(jsonError){console.error('JSON解析失败:',jsonError.message);console.error('原始数据:',jsonData);return null}}if(encryptedContent){console.log('使用content参数方式获取数据');const decryptedJson=decryptContent(encryptedContent);if(!decryptedJson.trim().startsWith('{')&&!decryptedJson.trim().startsWith('[')){console.error('可能的原因: 加解密不匹配或数据损坏');return null}let data;try{data=JSON.parse(decryptedJson)}catch(jsonError){console.error('JSON解析失败:',jsonError.message);console.error('原始数据:',decryptedJson);try{const fixedJson=decryptedJson.replace(/[\x00-\x1F\x7F-\x9F]/g,'').replace(/\\n/g,'\\\\n').replace(/\\n/g,'\\\\n').replace(/\\t/g,'\\\\t');data=JSON.parse(fixedJson);console.log('修复后成功解析JSON')}catch(fixError){console.error('JSON修复也失败:',fixError.message);return null}}console.log('content方式成功解析数据');return data}console.warn('未找到token或content参数');return null}catch(error){console.error('解密过程失败:',error);return null}};
document.addEventListener('DOMContentLoaded',async()=>{console.log('开始解密URL参数中的内容...');const decryptedData=await getDecryptedContent();if(decryptedData){console.log('页面标题:',decryptedData.title);console.log('引擎类型:',decryptedData.engineType);console.log('HTML内容长度:',decryptedData.html?.length||0);console.log('CSS内容长度:',decryptedData.css?.length||0);console.log('JS内容长度:',decryptedData.js?.length||0)}else{console.error('解密失败或无有效数据')}if(!decryptedData){console.error('无有效解密数据，停止处理');return}const{engineType,html,css,js,title,description,headHtmlContent,cssLinks,jsLinks,jsType}=decryptedData;try{if(title)document.title=title;if(description){let metaDesc=document.querySelector('meta[name="description"]');if(!metaDesc){metaDesc=document.createElement('meta');metaDesc.name='description';document.head.appendChild(metaDesc)}metaDesc.content=description}if(headHtmlContent){const tempDiv=document.createElement('div');tempDiv.innerHTML=headHtmlContent;Array.from(tempDiv.children).forEach(child=>{document.head.appendChild(child.cloneNode(true))})}if(cssLinks&&cssLinks.length>0){cssLinks.forEach(link=>{if(link.trim()){const linkElement=document.createElement('link');linkElement.rel='stylesheet';linkElement.href=link.trim();document.head.appendChild(linkElement)}})}if(css){const styleElement=document.createElement('style');styleElement.textContent=css;document.head.appendChild(styleElement)}if(html){const tempDiv=document.createElement('div');tempDiv.innerHTML=html;Array.from(tempDiv.children).forEach(child=>{document.body.appendChild(child.cloneNode(true))})}const loadThirdPartyLibraries=()=>new Promise((resolve,reject)=>{if(!jsLinks||jsLinks.length===0){resolve([]);return}const validLinks=jsLinks.filter(link=>link.trim());if(validLinks.length===0){resolve([]);return}let loadedCount=0;let errorCount=0;const totalLinks=validLinks.length;const results=[];console.log(`开始加载 ${totalLinks} 个第三方库...`);validLinks.forEach((link,index)=>{const scriptElement=document.createElement('script');scriptElement.src=link.trim();scriptElement.async=false;scriptElement.onload=()=>{loadedCount++;results[index]={success:true,link};console.log(`第三方库加载成功 (${loadedCount}/${totalLinks}): ${link}`);if(loadedCount+errorCount===totalLinks){console.log('所有第三方库加载完成');resolve(results)}};scriptElement.onerror=()=>{errorCount++;results[index]={success:false,link,error:'加载失败'};console.error(`第三方库加载失败 (${errorCount}/${totalLinks}): ${link}`);if(loadedCount+errorCount===totalLinks){console.log('第三方库加载完成（部分失败）');resolve(results)}};document.head.appendChild(scriptElement)})});const executeUserScript=()=>{if(js){try{console.log('开始执行用户脚本...');const scriptElement=document.createElement('script');scriptElement.textContent=js;if(jsType&&jsType==='module')scriptElement.type='module';document.body.appendChild(scriptElement);console.log('用户脚本执行完成')}catch(error){console.error('用户脚本执行出错:',error)}else{console.log('无用户脚本需要执行')}};loadThirdPartyLibraries().then(results=>{const successCount=results.filter(r=>r.success).length;const failureCount=results.length-successCount;if(failureCount>0)console.warn(`${failureCount} 个第三方库加载失败，但仍继续执行用户脚本`);setTimeout(executeUserScript,100)}).catch(error=>{console.error('加载第三方库时出现异常:',error);executeUserScript()});console.log('页面内容更新完成')}catch(error){console.error('更新页面内容时出错:',error)}});
window.decryptPreviewContent=getDecryptedContent;